 
# Домашнее задание №5
В рамках данного задания выполняется настройка резервного копирования postgresql при помощи pg_probackup.

---
## Подготовка
Задание будет выполняться на трёх локальных виртуальных машинах:
1. мастер;
2. реплика;
3. сервер резервного копирования.

Далее, в ходе работы сервера буду называть как в списке выше.

Перед продолжением стоит их подготовить, во избежание путаницы - переименовать хосты (особенно, если машины создавались из одного шаблона), при помощи команды:
```
wr@bubuntu20042:~$ sudo hostnamectl set-hostname master
```
Также, новое имя хоста требуется указать в /etc/hosts. Для упрощения будущей настройки стоит заодно добавить в /etc/hosts имена остальных виртуальных машин, если нет возможности внесения изменений в конфигурацию DNS-сервера. Пример добавленных строк на мастере:
```
127.0.0.1 master
192.168.122.188 replica
192.168.122.101 pgprobackup
```
После перезапуска сессии пользователя (например из-за переподключения к SSH) в терминале будет отображаться новое имя сервера.

На мастер и реплику PostgreSQL установлен ранее из репозитория PGDG, версия - 15.7.

### Репликация
Планируется попытка настройки резервного копирования с реплики БД, например - для снижения нагрузки на мастер. Для этого следует настроить репликацию. Предполагается постоянная работа реплики, поэтому при использовании слотов репликации проблем с утечкой занятого дискового пространства не будет.

На (предполагается что полностью настроенном и доступном) мастере создан пользователь с правом репликации, при помощи SQL-запроса:
```
CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD 'secret';
```
Далее для разрешения подключения к postgresql с других машин для репликации, на мастере и реплике в /etc/postgresql/15/main/pg_hba.conf добавлена строка:
```
host    replication     replicator      192.168.122.0/24        scram-sha-256
```
Для упрощения указан диапазон IP, в продуктивных средах стоит добавлять несколько строк с индивидуальными IP только тех машин, с которых планируется подключаться (в том числе для репликации). После добавления строк при запущенной службе PostgreSQL следует перечитать конфигурацию, например, при помощи SQL-запроса:
```
SELECT pg_reload_conf();
```
Далее, на реплике следует остановить сервис PostgreSQL, если он был запущен, очистить каталог данных (по умолчанию - `/var/lib/postgresql/15/main/*`), и сделать полную копию данных мастера, например, при помощи команды:
```
sudo -u postgres pg_basebackup -h master -U replicator -p 5432 -D /var/lib/postgresql/15/main -Fp -Xs -P -R
```
В каталоге данных на реплике появился файл `standby.signal`, говорящий о том что сервер работает в режиме резерва (то есть, реплики). Также, в postgresql.auto.conf на реплике появился параметр primary_conninfo с данными для подключения к мастеру.
Так как решено использовать слот репликации, следует создать его на мастере, при помощи SQL-запроса:
```
SELECT pg_create_physical_replication_slot('standby_slot');
```
...и добавить информацию о нём в postgresql.conf (или postgresql.auto.conf) на реплике:
```
primary_slot_name = 'standby_slot'
```
После внесенных изменений можно запустить службу PostgreSQL на реплике, и проверить статус репликации на мастере:
```
postgres=# SELECT * FROM pg_stat_replication;
-[ RECORD 1 ]----+------------------------------
pid              | 4815
usesysid         | 16388
usename          | replicator
application_name | 15/main
client_addr      | 192.168.122.188
client_hostname  | 
client_port      | 33698
backend_start    | 2024-05-31 09:01:47.885823+05
backend_xmin     | 
state            | streaming
sent_lsn         | 0/3000148
write_lsn        | 0/3000148
flush_lsn        | 0/3000148
replay_lsn       | 0/3000148
write_lag        | 
flush_lag        | 
replay_lag       | 
sync_priority    | 0
sync_state       | async
reply_time       | 2024-05-31 09:02:48.034217+05

postgres=# SELECT * FROM pg_replication_slots;
-[ RECORD 1 ]-------+-------------
slot_name           | standby_slot
plugin              | 
slot_type           | physical
datoid              | 
database            | 
temporary           | f
active              | t
active_pid          | 4815
xmin                | 
catalog_xmin        | 
restart_lsn         | 0/3000148
confirmed_flush_lsn | 
wal_status          | reserved
safe_wal_size       | 
two_phase           | f
```
По выводу этих запросов видно что к мастеру подключена реплика, и активен созданный слот репликации. Заодно, можно создать некоторое количество тестовых данных:
```
postgres=# CREATE TABLE testtable (id serial, data text);
CREATE TABLE
postgres=# INSERT INTO testtable select nextval('testtable_id_seq'::regclass), md5(generate_series(1,1000000)::text);
INSERT 0 1000000
```
Созданные данные также будут присутствовать на реплике.